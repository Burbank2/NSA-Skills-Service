<script setup>
import { computed, ref, onMounted, provide } from 'vue'
import { useProjConfig } from '@/stores/UseProjConfig.js'
import { useSubjectSkillsState } from '@/stores/UseSubjectSkillsState.js'
import { useSubjectsState } from '@/stores/UseSubjectsState.js'
import { useRoute } from 'vue-router'
import { useSkillsAnnouncer } from '@/common-components/utilities/UseSkillsAnnouncer.js'
import SubPageHeader from '@/components/utils/pages/SubPageHeader.vue'
import SkillsTable from '@/components/skills/SkillsTable.vue'
import NoContent2 from '@/components/utils/NoContent2.vue'
import EditSkill from '@/components/skills/EditSkill.vue'
import { SkillsReporter } from '@skilltree/skills-client-js'
import EditSkillGroup from '@/components/skills/skillsGroup/EditSkillGroup.vue'

const projConfig = useProjConfig()
const route = useRoute()
const skillsState = useSubjectSkillsState()
const subjectState = useSubjectsState()
const announcer = useSkillsAnnouncer()
const isLoading = computed(() => {
  // return this.loadingSubjectSkills || this.isLoadingProjConfig;
  return false
})

const addSkillDisabled = computed(() => {
  // return this.skills && this.$store.getters.config && this.numSubjectSkills >= this.$store.getters.config.maxSkillsPerSubject;
  return false
})

const showImportDialog = ref(false)
const editGroup = ref({
  skill: {},
  show: false,
  isEdit: false,
})
const createOrUpdateGroup = (skill = {}, isEdit = false) => {
  editGroup.value = {
    skill,
    isEdit,
    show: true,
  }
}
provide('createOrUpdateGroup', createOrUpdateGroup)

onMounted(() => {
  skillsState.loadSubjectSkills(route.params.projectId, route.params.subjectId)
})

const newSkillInfo = ref({
  skill: {},
  show: false,
  isEdit: false,
  isCopy: false,
  groupId: null,
  version: 1
})
const createOrUpdateSkill = (skill = {}, isEdit = false, isCopy = false, groupId = null) => {
  console.log(skill)
  if (skill.isGroupType) {
    createOrUpdateGroup(skill, isEdit)
  } else {
    newSkillInfo.value = {
      skill,
      isEdit,
      show: true,
      isCopy,
      groupId
    }
  }
}
provide('createOrUpdateSkill', createOrUpdateSkill)

const reportSkills = (createdSkill) => {
  if (createdSkill.pointIncrementInterval <= 0) {
    SkillsReporter.reportSkill('CreateSkillDisabledTimeWindow')
  }
  if (createdSkill.numMaxOccurrencesIncrementInterval > 1) {
    SkillsReporter.reportSkill('CreateSkillMaxOccurrencesWithinTimeWindow')
  }
  if (createdSkill.helpUrl) {
    SkillsReporter.reportSkill('CreateSkillHelpUrl')
  }
}

const skillCreatedOrUpdated = (skill) => {
  const skills = skill.groupId ? skillsState.getGroupSkills(skill.groupId) : skillsState.subjectSkills
  const item1Index = skills.findIndex((item) => item.skillId === skill.originalSkillId)
  const createdSkill = ({
    ...skill,
    subjectId: route.params.subjectId
  })
  if (item1Index >= 0) {
    skills.splice(item1Index, 1, createdSkill)
  } else {
    skills.push(createdSkill)
    SkillsReporter.reportSkill('CreateSkill')
  }
  if (skill.groupId) {
    skillsState.setGroupSkills(skill.groupId, skills)
    const parentGroup = skillsState.subjectSkills.find((item) => item.skillId = skill.groupId)
    const groupSkills = skillsState.getGroupSkills(skill.groupId)
    parentGroup.totalPoints = groupSkills
      .map((item) => item.totalPoints)
      .reduce((accumulator, currentValue) => {
        return accumulator + currentValue
      }, 0)

    parentGroup.numSkillsInGroup = groupSkills.length
  }
  // attribute based skills should report on new or update operation
  reportSkills(createdSkill)

  subjectState.loadSubjectDetailsState()

  const msg = skill.type === 'SkillGroup' ? `Group ${skill.name} has been saved` : `Skill ${skill.name} has been saved`
  announcer.polite(msg)
  return createdSkill
}

</script>

<template>
  <div>
    <!--    :disabled="addSkillDisabled"-->
    <!--    :disabled-msg="addSkillsDisabledMsg"-->
    <sub-page-header
      ref="subPageHeader"
      title="Skills"
      :is-loading="isLoading"
      aria-label="new skill">
      <div v-if="!projConfig.isReadOnlyProj">
        <!--        <i v-if="addSkillDisabled" class="fas fa-exclamation-circle text-warning ml-1 mr-1"-->
        <!--           style="pointer-events: all; font-size: 1.5rem;"-->
        <!--           :aria-label="addSkillsDisabledMsg"-->
        <!--           v-b-tooltip.hover="addSkillsDisabledMsg"/>-->
        <SkillsButton
          id="importFromCatalogBtn"
          ref="importFromCatalogBtn"
          label="Import"
          outlined
          class="bg-primary-reverse"
          icon="fas fa-book"
          @click="showImportDialog=true"
          size="small"
          aria-label="import from catalog"
          data-cy="importFromCatalogBtn" />
        <SkillsButton
          id="newGroupBtn"
          ref="newGroupButton"
          label="Group"
          icon="fas fa-plus-circle"
          @click="createOrUpdateGroup"
          size="small"
          outlined
          class="bg-primary-reverse ml-1"
          aria-label="new skills group"
          aria-describedby="newGroupSrText"
          data-cy="newGroupButton"
          :aria-disabled="addSkillDisabled"
          :disabled="addSkillDisabled" />
        <SkillsButton
          id="newSkillBtn"
          ref="newSkillButton"
          label="Skill"
          icon="fas fa-plus-circle"
          @click="createOrUpdateSkill"
          variant="outline-primary"
          size="small"
          aria-label="new skill"
          aria-describedby="newSkillSrText"
          data-cy="newSkillButton"
          outlined
          class="bg-primary-reverse ml-1"
          :track-for-focus="true"
          :aria-disabled="addSkillDisabled"
          :disabled="addSkillDisabled" />
      </div>
    </sub-page-header>


    <Card :pt="{ body: { class: 'p-0' }, content: { class: 'p-0' } }">
      <template #content>
        <skills-spinner
          v-if="skillsState.loadingSubjectSkills && !skillsState.hasSkills "
          :is-loading="skillsState.loadingSubjectSkills"
          extraClass="py-8 my-0 h-23rem" />
        <skills-table v-if="skillsState.hasSkills" />
        <no-content2
          v-if="!skillsState.loadingSubjectSkills && !skillsState.hasSkills"
          title="No Skills Yet"
          class="py-8"
          message="Projects are composed of Subjects which are made of Skills and a single skill defines a training unit within the gamification framework." />
      </template>
    </Card>

    <edit-skill
      v-if="newSkillInfo.show"
      v-model="newSkillInfo.show"
      :skill="newSkillInfo.skill"
      :is-edit="newSkillInfo.isEdit"
      :is-copy="newSkillInfo.isCopy"
      :group-id="newSkillInfo.groupId"
      @skill-saved="skillCreatedOrUpdated"
    />

    <edit-skill-group
      v-if="editGroup.show"
      v-model="editGroup.show"
      :skill="editGroup.skill"
      :is-edit="editGroup.isEdit"
      @skill-saved="skillCreatedOrUpdated"
      />
  </div>
</template>

<style scoped></style>
