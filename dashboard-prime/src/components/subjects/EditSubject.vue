<script setup>
import { computed, onMounted, ref } from 'vue'
import SkillsInputFormDialog from '@/components/utils/inputForm/SkillsInputFormDialog.vue'
import { object, string } from 'yup'
import { useRoute } from 'vue-router'
import { useAppConfig } from '@/common-components/stores/UseAppConfig.js'
import SubjectsService from '@/components/subjects/SubjectsService'
import InputSanitizer from '@/components/utils/InputSanitizer'
import MarkdownEditor from '@/common-components/utilities/markdown/MarkdownEditor.vue'
import HelpUrlInput from '@/components/utils/HelpUrlInput.vue'
import SkillsNameAndIdInput from '@/components/utils/inputForm/SkillsNameAndIdInput.vue'
import IconPicker from '@/components/utils/iconPicker/IconPicker.vue'

const model = defineModel()
const props = defineProps({
  subject: Object,
  isEdit: Boolean,
  value: Boolean
})
const appConfig = useAppConfig()
const emit = defineEmits(['hidden', 'subject-saved'])
const route = useRoute()

let formId = 'newSubjectDialog'
let modalTitle = 'New Subject'
if (props.isEdit) {
  formId = `editSubjectDialog-${route.params.projectId}-${props.subject.subjectId}`
  modalTitle = 'Editing Existing Subject'
}

let canAutoGenerateId = ref(true)
let restoredFromStorage = ref(false)
let currentFocus = ref(null)
let previousFocus = ref(null)

onMounted(() => {
  document.addEventListener('focusin', trackFocus)
})

const trackFocus = () => {
  previousFocus.value = currentFocus.value
  currentFocus.value = document.activeElement
}

const title = computed(() => {
  return props.isEdit ? 'Editing Existing Subject' : 'New Subject'
})


const close = () => {
  model.value = false
}

const onSelectedIcon = (selectedIcon) => {
  currentIcon.value = selectedIcon.css
}


const checkSubjectNameUnique = (value) => {
  if (!value || value === props.subject.name) {
    return true
  }
  return SubjectsService.subjectWithNameExists(route.params.projectId, value)
}

const checkSubjectIdUnique = (value) => {
  if (!value || value === props.subject.subjectId) {
    return true
  }
  return SubjectsService.subjectWithIdExists(route.params.projectId, value)
}

const schema = object({
  'subjectName': string()
    .trim()
    .required()
    .min(appConfig.minNameLength)
    .max(appConfig.maxSubjectNameLength)
    .nullValueNotAllowed()
    .customNameValidator('Subject Name')
    .test('uniqueName', 'Subject Name is already taken', (value) => checkSubjectNameUnique(value))
    .label('Subject Name'),
  'subjectId': string()
    .trim()
    .required()
    .min(appConfig.minIdLength)
    .max(appConfig.maxIdLength)
    .nullValueNotAllowed()
    .idValidator()
    .test('uniqueName', 'Subject ID is already taken', (value) => checkSubjectIdUnique(value))
    .label('Subject ID'),
  'description': string()
    .max(appConfig.descriptionMaxLength)
    .customDescriptionValidator('Subject Description')
    .label('Subject Description'),
  'helpUrl': string()
    .urlValidator()
    .label('Help URL')
})

const initialSubjData = {
  projectId: route.params.projectId,
  subjectId: props.subject.subjectId || '',
  subjectName: props.subject.name || '',
  helpUrl: props.subject.helpUrl || '',
  description: props.subject.description || '',
  iconClass: props.subject.iconClass || 'fas fa-book'
}

const currentIcon = ref((props.subject.iconClass || 'fas fa-book'))

const updateSubject = (values) => {
  const subjToSave = {
    ...values,
    iconClass: currentIcon.value,
    originalSubjectId: props.subject.subjectId,
    projectId: route.params.projectId,
    isEdit: props.isEdit,
    name: InputSanitizer.sanitize(values.subjectName),
    subjectId: InputSanitizer.sanitize(values.subjectId)
  }
  return SubjectsService.saveSubject(subjToSave).then((subjRes) => {
    return {
      ...subjRes,
      originalSubjectId: props.subject.subjectId
    }
  })
}
const onSubjectSaved = (subject) => {
  emit('subject-saved', subject)
  close()
}

</script>

<template>
  <SkillsInputFormDialog
    :id="formId"
    v-model="model"
    :header="modalTitle"
    saveButtonLabel="Save"
    :validation-schema="schema"
    :initial-values="initialSubjData"
    :save-data-function="updateSubject"
    :enable-return-focus="true"
    @saved="onSubjectSaved"
    @close="close">
    <template #default>
      <SkillsNameAndIdInput
        name-label="Subject Name"
        name-field-name="subjectName"
        id-label="Subject ID"
        id-field-name="subjectId"
        id-suffix="Subject"
        :name-to-id-sync-enabled="!props.isEdit">
        <template #beforeName>
          <icon-picker
            class="mb-3"
            :startIcon="currentIcon"
            @selected-icon="onSelectedIcon"
          />
        </template>
      </SkillsNameAndIdInput>

      <markdown-editor class="" name="description" />
      <help-url-input class="mt-3"
                      :next-focus-el="previousFocus"
                      name="helpUrl"
                      @keydown-enter="emit('keydown-enter')" />
    </template>
  </SkillsInputFormDialog>
</template>

<style scoped>

.icon-button {
  cursor: pointer;
  height: 100px;
  width: 100px;
  background-color: transparent;
}

.icon-button:disabled {
  background-color: lightgrey;
  cursor: none;
}
</style>
